# IR関連資料比較分析システム仕様書

## 1. 概要
IR（Investor Relations）関連資料の要約文書を複数比較し、共通点・差異を分析するWebアプリケーション。

## 2. 業務要件

### 2.1 基本機能
- 基準企業の要約と比較企業（1〜4社）の要約を入力
- 要約比較のためのプロンプトを入力
- LLMを使用した比較分析の実行
- 分析結果の表示

### 2.2 入力要件
#### 企業要約入力
- **基準企業**: 1社（必須）
  - 企業名入力フィールド
  - 要約テキストエリア
- **比較企業**: 1〜4社（可変）
  - 企業名入力フィールド
  - 要約テキストエリア
- **入力形式**: テキストエリア
- **文字数制限**: 要検討

#### プロンプト入力・管理
- **動的参照**: プロンプト内で各企業の要約を参照可能
- **参照形式**: `{基準企業}`, `{比較企業1}`, `{比較企業2}` 等
- **参照数**: 企業数に応じて動的変更
- **プロンプト保存**: 
  - プロンプト名での保存・呼び出し
  - ローカルストレージでの永続化
  - CRUD操作（作成・読み込み・更新・削除）

### 2.3 LLM設定要件
#### LLM切り替え機能
- 使用するLLMを選択可能
- 対応済みLLM:
  - Azure OpenAI GPT-4o
  - Azure OpenAI GPT-4o Mini
  - Azure OpenAI GPT-4.1 Mini
  - Gemini 2.0 Flash
  - Gemini 1.5 Pro

#### 設定管理
- **環境変数管理**: `.env.local`で管理
- **設定項目**:
  - Azure OpenAI API Key または Azure AD認証
  - Azure OpenAI Endpoint
  - Azure OpenAI Deployment名
  - Gemini API Key
  - Temperature, Max Tokens等のパラメータ

### 2.4 出力要件
#### 分析結果
- **形式**: テキスト形式
- **内容**: LLMによる比較分析結果

#### 使用量表示
- **入力トークン数**: リクエスト時のトークン数
- **出力トークン数**: レスポンス時のトークン数
- **推定料金**: モデル別料金計算

## 3. 技術要件

### 3.1 フロントエンド
- **フレームワーク**: Next.js (App Router)
- **スタイリング**: Tailwind CSS v3
- **言語**: TypeScript

### 3.2 バックエンド
- **API**: Next.js API Routes
- **LLM API**: 各プロバイダーのREST API

### 3.3 設定管理
- **環境変数**: `.env.local`で API Key等の秘密情報を管理
- **デフォルト設定**: コード内で各LLMモデルの設定を定義

## 4. 画面設計

### 4.1 メイン画面（タブ構成）
#### 全体レイアウト
```
┌─────────────────────────────────────┐
│ ヘッダー（タイトル、LLM設定）          │
├─────────────────────────────────────┤
│ [要約入力] [プロンプト] [結果表示]     │
├─────────────────────────────────────┤
│ タブコンテンツエリア                 │
│                                   │
└─────────────────────────────────────┘
```

### 4.2 タブ1: 要約入力
```
┌─────────────────────────────────────┐
│ 企業要約入力エリア                   │
│ ┌─────────────────────────────────┐ │
│ │ 基準企業要約（必須）              │ │
│ │ [企業名入力] [テキストエリア]      │ │
│ └─────────────────────────────────┘ │
│ ┌─────────────────────────────────┐ │
│ │ 比較企業1要約                   │ │
│ │ [企業名入力] [テキストエリア]      │ │
│ └─────────────────────────────────┘ │
│ [+ 企業追加] (最大4社まで)            │
│                                   │
│ [次へ：プロンプト入力] ボタン          │
└─────────────────────────────────────┘
```

### 4.3 タブ2: プロンプト
```
┌─────────────────────────────────────┐
│ プロンプト管理エリア                 │
│ ┌─────────────────────────────────┐ │
│ │ 保存済みプロンプト選択             │ │
│ │ [プロンプト選択ドロップダウン] [新規]│ │
│ └─────────────────────────────────┘ │
│ ┌─────────────────────────────────┐ │
│ │ プロンプト名                     │ │
│ │ [プロンプト名入力]                │ │
│ └─────────────────────────────────┘ │
│ ┌─────────────────────────────────┐ │
│ │ プロンプト内容                   │ │
│ │ [テキストエリア]                 │ │
│ │ 動的参照: {基準企業}, {比較企業1} │ │
│ └─────────────────────────────────┘ │
│ [保存] [削除] [実行] ボタン           │
└─────────────────────────────────────┘
```

### 4.4 タブ3: 結果表示
```
┌─────────────────────────────────────┐
│ 実行情報                           │
│ LLM: GPT-4 | プロンプト: 比較分析v1  │
├─────────────────────────────────────┤
│ 分析結果エリア                      │
│ ┌─────────────────────────────────┐ │
│ │ [分析結果テキスト]                │ │
│ │                                 │ │
│ │                                 │ │
│ └─────────────────────────────────┘ │
├─────────────────────────────────────┤
│ 使用量・料金情報                    │
│ 入力: ○○tokens | 出力: ○○tokens    │
│ 推定料金: $○.○○                    │
│ [結果をコピー] [再実行] ボタン        │
└─────────────────────────────────────┘
```

## 5. データフロー

### 5.1 分析実行フロー
1. **要約入力タブ**: ユーザーが企業要約を入力
2. **プロンプトタブ**: ユーザーがプロンプトを選択/編集（動的参照含む）
3. ユーザーがLLMを選択（ヘッダー）
4. 実行ボタンクリック
5. プロンプト内の参照を実際の要約で置換
6. 選択されたLLM APIにリクエスト送信
7. **結果表示タブ**: レスポンスを受信・表示
8. トークン数・料金を計算・表示

### 5.2 プロンプト管理フロー
1. プロンプト一覧をローカルストレージから読み込み
2. 新規作成 or 既存プロンプト選択
3. プロンプト編集・保存
4. 削除時は確認ダイアログ表示

### 5.3 設定管理フロー
1. 環境変数から認証情報読み込み
2. 利用可能なLLMの確認
3. LLM選択肢の動的生成
4. API呼び出し時の設定適用

## 6. 実装優先度

### Phase 1 (MVP)
- [ ] タブ構成の基本UI実装
- [ ] 企業要約入力機能（企業名 + 要約）
- [ ] 基本的なプロンプト入力機能
- [ ] Azure OpenAI と Gemini 対応
- [ ] 基本的な結果表示

### Phase 2
- [ ] プロンプト保存・管理機能
- [ ] 動的プロンプト参照機能
- [ ] トークン数・料金計算
- [ ] 高度な設定管理

### Phase 3
- [ ] UI/UX改善（アニメーション、レスポンシブ）
- [ ] エラーハンドリング強化
- [ ] プロンプトテンプレート機能
- [ ] 分析結果の保存・エクスポート
- [ ] パフォーマンス最適化
- [ ] テスト実装

## 7. 注意事項
- API Keyの安全な管理
- レート制限への対応
- エラーハンドリング
- レスポンシブデザイン対応
